<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>ğŸ çš„è¿”å›¾Â·é¦–é¡µ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='theme.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <!-- å¼•å…¥JSZipå’ŒFileSaver.jsåº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script>
        // ç”¨äºå­˜å‚¨é¢„åŠ è½½çš„åŸå›¾
        const imageCache = new Map();

        // é¢„åŠ è½½åŸå›¾
        async function preloadOriginalImage(username, filename) {
            if (!imageCache.has(filename)) {
                try {
                    const response = await fetch(`/image/${username}/${filename}`);
                    const blob = await response.blob();
                    imageCache.set(filename, blob);
                    console.log(`é¢„åŠ è½½å›¾ç‰‡ ${filename} æˆåŠŸ`);
                } catch (error) {
                    console.error(`é¢„åŠ è½½å›¾ç‰‡ ${filename} å¤±è´¥:`, error);
                }
            }
        }

        // å½“é€‰ä¸­å›¾ç‰‡æ—¶é¢„åŠ è½½åŸå›¾
        function onImageSelect(checkbox) {
            const filename = checkbox.dataset.filename;
            const username = checkbox.dataset.user;
            
            if (checkbox.checked) {
                preloadOriginalImage(username, filename);
            }
        }
    </script>
</head>
<style>
    .content {
        max-width: 1400px;
        width: 85%;
        /* å±…ä¸­ */
        margin: 0 auto;
        margin-bottom: 30px;
    }
</style>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-brand" id="navbar-info">æ¬¢è¿, {{ current_user.username }}</div>
            <div class="navbar-actions" id="navbar-actions">
                <button onclick="downloadIndividually()">ä¸‹è½½</button>
                <button onclick="clearSelection()">æ¸…é™¤</button>
                <button onclick="selectAll()">å…¨é€‰</button>
                <button onclick="invertSelection()">åé€‰</button>
            </div>
            <div class="navbar-auth">
                {% if current_user.is_authenticated %}
                    <a href="{{ url_for('logout') }}" class="nav-link">æ³¨é”€</a>
                {% else %}
                    <a href="{{ url_for('login') }}" class="nav-link">ç™»å½•</a>
                    <a href="{{ url_for('register') }}" class="nav-link">æ³¨å†Œ</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <div class="content">
        {% if is_admin %}
        <h2>ç®¡ç†å‘˜è§†å›¾</h2>
        {% endif %}
        <div id="gallery">
            {% for user, user_images in images.items() %}
            {% for image in user_images %}
            <div class="image-container">
                <input type="checkbox" class="select-checkbox" data-filename="{{ image }}" data-user="{{ user }}" onclick="updateNavbar(); toggleImageSize(this); onImageSelect(this)">
                <img src="{{ url_for('thumbnail', username=user, filename=image) }}" class="thumbnail" loading="lazy" onclick="viewImage('{{ user }}', '{{ image }}')">
            </div>
            {% endfor %}
            {% endfor %}
        </div>
    </div>

    <div id="fullscreen-view" style="display:none;" onclick="closeFullscreen(event)">
        <img id="fullscreen-image" class="fullscreen" draggable="false">
        <button class="back-btn" onclick="closeFullscreen(event)">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M15 18L9 12L15 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>

    </div>

    <!-- é¡µè„š -->
    <footer class="footer">
        <div class="container">
            <p>&copy; ğŸ çš„è¿”å›¾. ç‰ˆæƒæ‰€æœ‰. 
                <a href="https://github.com/ID-VerNe/PhotoViewer" target="_blank" style="color: #fff; text-decoration: none;">
                    <img src="{{ url_for('static', filename='images/github-mark.png') }}" alt="GitHub" style="width: 20px; vertical-align: middle; margin-left: 10px;">
                    GitHub
                </a>
            </p>
        </div>
    </footer>

    <script src="{{ url_for('static', filename='scripts.js') }}"></script>
    <script>
        async function downloadIndividually() {
            const checkboxes = document.querySelectorAll('.select-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦ä¸‹è½½çš„å›¾ç‰‡');
                return;
            }

            for (const checkbox of checkboxes) {
                const filename = checkbox.dataset.filename;
                const username = checkbox.dataset.user;
                
                // ä»ç¼“å­˜ä¸­è·å–å›¾ç‰‡
                let imageBlob = imageCache.get(filename);
                
                // å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ï¼Œåˆ™é‡æ–°è·å–
                if (!imageBlob) {
                    try {
                        const response = await fetch(`/image/${username}/${filename}`);
                        imageBlob = await response.blob();
                    } catch (error) {
                        console.error(`ä¸‹è½½å›¾ç‰‡ ${filename} å¤±è´¥:`, error);
                        continue;
                    }
                }
                
                // ä½¿ç”¨æµè§ˆå™¨ä¸‹è½½å™¨ä¸‹è½½
                const url = window.URL.createObjectURL(imageBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }
        }
    </script>
</body>
</html> 